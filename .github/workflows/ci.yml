name: TOPAS-nBio CI

on:
  push:
    branches:
      - workflow
    paths-ignore:
      - '*.md'
  workflow_dispatch:
  pull_request:
    branches:
      - workflow
    paths-ignore:
      - '*.md'

jobs:
  docker-tests:
    name: Docker Tests
    runs-on: ubuntu-latest
    env:
      TOPAS_DOCKER_IMAGE: opentopas/opentopas:v4.1.0
      G4DATA_DIR: ${{ github.workspace }}/.cache/GEANT4/G4DATA
      TEST_SUITE_DIR: ${{ github.workspace }}/qi-topas-nbio
      NRTEST_ENV: ${{ github.workspace }}/.cache/nrtest-env

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Geant4 data
        id: cache-g4data
        uses: actions/cache@v4
        with:
          path: ${{ env.G4DATA_DIR }}
          key: g4data-G4EMLOW-8.2-G4ENSDFSTATE-2.3

      - name: Download Geant4 EMLOW & ENSDFSTATE datasets
        if: steps.cache-g4data.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          mkdir -p "$G4DATA_DIR"
          cd "$G4DATA_DIR"
          curl -sSLO https://cern.ch/geant4-data/datasets/G4EMLOW.8.2.tar.gz
          tar -xzf G4EMLOW.8.2.tar.gz
          rm G4EMLOW.8.2.tar.gz
          curl -sSLO https://cern.ch/geant4-data/datasets/G4ENSDFSTATE.2.3.tar.gz
          tar -xzf G4ENSDFSTATE.2.3.tar.gz
          rm G4ENSDFSTATE.2.3.tar.gz

      - name: Pull OpenTOPAS Docker image
        run: docker pull $TOPAS_DOCKER_IMAGE

      - name: Download TOPAS docker launcher
        run: |
          curl -sSfL https://raw.githubusercontent.com/OpenTOPAS/OpenTOPAS/fix-bugs/docker/topas-docker -o docker-run
          chmod +x docker-run

      - name: Install nrtest tooling
        run: |
          python -m venv "$NRTEST_ENV"
          source "$NRTEST_ENV/bin/activate"
          python -m pip install --upgrade pip
          python -m pip install nrtest git+https://github.com/davidchall/nrtest-topas.git

      - name: Fetch qi-topas-nbio tests (latest tag)
        run: |
          set -euo pipefail
          LATEST_TAG=$(git ls-remote --tags --sort='v:refname' https://github.com/topas-nbio/qi-topas-nbio.git | awk -F/ '/refs\/tags/ {print $NF}' | grep -v '\^{}' | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            echo "Unable to determine latest tag; falling back to main"
            LATEST_TAG=main
          fi
          git clone --depth 1 --branch "$LATEST_TAG" https://github.com/topas-nbio/qi-topas-nbio.git "$TEST_SUITE_DIR"

      - name: Configure nrtest app manifest
        run: |
          cat <<EOF > "$TEST_SUITE_DIR/apps/topas-docker.json"
          {
            "name": "topas",
            "version": "$GITHUB_SHA",
            "exe": "$GITHUB_WORKSPACE/.github/scripts/run-topas-docker.sh"
          }
          EOF

      - name: Run qi-topas-nbio test suite
        id: nrtest
        env:
          TOPAS_NBIO_ROOT: ${{ github.workspace }}
          TOPAS_DOCKER_LAUNCHER: ${{ github.workspace }}/docker-run
          G4DATA_DIR: ${{ env.G4DATA_DIR }}
        run: |
          set -euo pipefail
          source "$NRTEST_ENV/bin/activate"
          cd "$TEST_SUITE_DIR"
          if [ -d benchmark ]; then
            find benchmark -mindepth 1 -maxdepth 1 -type d -regex '.*/[0-9].*' -exec rm -rf {} +
          fi
          BENCHMARK_DIR="benchmark/${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%Y-%m-%d-%H%M%S)"
          rm -rf "$BENCHMARK_DIR"
          mkdir -p "$(dirname "$BENCHMARK_DIR")"
          echo "benchmark_dir=$TEST_SUITE_DIR/$BENCHMARK_DIR" >> "$GITHUB_OUTPUT"
          nrtest execute apps/topas-docker.json tests/ -o "$BENCHMARK_DIR"

      - name: Compare against TOPAS-nBio-v4.0_2025Nov09
        if: steps.nrtest.outputs.benchmark_dir != ''
        env:
          NRTEST_ENV: ${{ env.NRTEST_ENV }}
          TEST_SUITE_DIR: ${{ env.TEST_SUITE_DIR }}
        run: |
          set -euo pipefail
          source "$NRTEST_ENV/bin/activate"
          cd "$TEST_SUITE_DIR"
          BENCHMARK_DIR="${{ steps.nrtest.outputs.benchmark_dir }}"
          nrtest compare "benchmark/TOPAS-nBio-v4.0_2025Nov09" "$BENCHMARK_DIR"

      - name: Upload nrtest benchmark
        if: always() && steps.nrtest.outputs.benchmark_dir != ''
        uses: actions/upload-artifact@v4
        with:
          name: nrtest-results-${{ github.run_id }}
          path: ${{ steps.nrtest.outputs.benchmark_dir }}
